<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cash Tow Me â€“ Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCQyOdOaBj7C65MdvVA-_at7VbsvOqLqIw",
    authDomain: "cash-dispatch.firebaseapp.com",
    projectId: "cash-dispatch",
    storageBucket: "cash-dispatch.firebasestorage.app",
    messagingSenderId: "79166345159",
    appId: "1:79166345159:web:c763c3d806d2fc24db53e2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>




  <style>
    body { font-family: Arial; padding:20px; text-align:center; }
    input, button { width:90%; padding:10px; margin:8px 0; }
    button { background:#007bff; color:white; border:none; cursor:pointer; }
    .card { border:1px solid #ddd; padding:10px; margin-top:10px; }
  </style>
</head>

<body>

<h2>ðŸš› Cash Tow Me â€“ Driver</h2>

<input id="name" placeholder="Driver Name">
<input id="city" placeholder="City">
<input id="truck" placeholder="Truck Type">
<button onclick="addDriver()">Add Driver</button>

<button onclick="openAdmin()">Admin Panel</button>

<br><br>
<div id="adminSection" style="display:none; margin-top:20px;">
  <h2>ðŸ›  Admin Dashboard</h2>

  <h3>ðŸš¨ Incoming Tow Requests</h3>
  <div id="requestsList"></div>

  <hr>

  <h3>ðŸš› All Drivers</h3>
  <div id="allDrivers"></div>
</div>






<script>
function addDriver() {

  const name = document.getElementById("name").value;
  const city = document.getElementById("city").value;
  const truck = document.getElementById("truck").value;

  if (!name || !city || !truck) {
    alert("Please fill all fields");
    return;
  }

  db.collection("drivers").add({
    name: name,
    city: city,
    truck: truck,
    approved: false,
    status: "OFF",
    createdAt: Date.now()
  })
  .then(() => {
    alert("Driver submitted for approval!");
  })
  .catch(error => {
    alert("Error: " + error.message);
  });

}





  const approvedDiv = document.getElementById("approved");
  const pendingDiv = document.getElementById("pending");

  db.collection("drivers").onSnapshot(snapshot => {

    approvedDiv.innerHTML = "";
    pendingDiv.innerHTML = "";

    snapshot.forEach(doc => {
      const d = doc.data();

     if (d.approved) {


        approvedDiv.innerHTML += `
          <div class="card">
            <strong>${d.name}</strong> - ${d.city}<br>
            Status: <strong>${d.status}</strong><br>
            <button onclick="toggleStatus('${doc.id}', '${d.status}')">
              Turn ${d.status === "ON" ? "OFF" : "ON"}
            </button>
          </div>
        `;

      } else {

        pendingDiv.innerHTML += `
          <div class="card">
            ${d.name}
            <button onclick="approveDriver('${doc.id}')">Approve</button>
          </div>
        `;

      }
    });

  });

}


loadAllDrivers();
loadRequests();


  const container = document.getElementById("requestsList");

  db.collection("requests")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {

      container.innerHTML = "";

      if (snapshot.empty) {
        container.innerHTML = "<p>No active requests.</p>";
        return;
      }

      snapshot.forEach(doc => {

        const r = doc.data();

        container.innerHTML += `
          <div class="card">
            <strong>Status:</strong> ${r.status}<br>
            <strong>Latitude:</strong> ${r.latitude}<br>
            <strong>Longitude:</strong> ${r.longitude}<br>
            <a href="https://www.google.com/maps?q=${r.latitude},${r.longitude}" target="_blank">
              Open in Maps
            </a><br><br>
            <button onclick="completeRequest('${doc.id}')">
              Mark Completed
            </button>
          </div>
        `;

      });

    });

}
function completeRequest(id) {
  db.collection("requests").doc(id).update({
    status: "completed"
  });
}

  const container = document.getElementById("allDrivers");

  db.collection("drivers").onSnapshot(snapshot => {

    container.innerHTML = "";

    snapshot.forEach(doc => {

      const d = doc.data();

      container.innerHTML += `
        <div class="card">
          <strong>${d.name}</strong><br>
          City: ${d.city}<br>
          Truck: ${d.truck}<br>
          Approved: ${d.approved ? "YES" : "NO"}<br>
          Status: ${d.status}<br>

          <button onclick="approveDriver('${doc.id}')">
            ${d.approved ? "Approved" : "Approve"}
          </button>

          ${d.approved ? `
            <button onclick="toggleStatus('${doc.id}', '${d.status}')">
              Turn ${d.status === "ON" ? "OFF" : "ON"}
            </button>
          ` : ""}

          <button onclick="deleteDriver('${doc.id}')">Delete</button>
        </div>
      `;

    });

  });

}



function approveDriver(id) {
  db.collection("drivers").doc(id).update({
    approved: true
  });
}


function deleteDriver(id) {
  db.collection("drivers").doc(id).delete();
}


function toggleStatus(id, currentStatus) {

  if (currentStatus === "OFF") {

    navigator.geolocation.getCurrentPosition(position => {

      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      db.collection("drivers").doc(id).update({
        status: "ON",
        latitude: lat,
        longitude: lng,
        lastUpdated: Date.now()
      });

    }, error => {
      alert("Location permission required to go online.");
    });

  } else {

    db.collection("drivers").doc(id).update({
      status: "OFF",
      latitude: null,
      longitude: null,
      lastUpdated: Date.now()
    });

  }

}


function openAdmin() {

  const password = prompt("Enter Admin Password");

  if (password === "admin123") {
    document.getElementById("adminSection").style.display = "block";
    loadAllDrivers();
  } else {
    alert("Wrong password");
  }

}


loadDrivers();

</script>
